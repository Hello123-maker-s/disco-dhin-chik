<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savings Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'savings/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

</head>
<body>
    <div id="popup-messages">
        {% if messages %}
            {% for message in messages %}
                <div class="popup-message {{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    </div>
<header><h1 class="page-title">ğŸ’° Savings Dashboard</h1><a href="{% url 'dashboard' %}">Dashboard</a></header>
<div style="display: flex; min-height: calc(100vh - 100px);">
{% include 'savings/sidebar.html' %}
<main style="flex: 1;">
    <h1 class="page-title">ğŸ’° Savings Dashboard</h1>
    <!-- Goals Summary Card -->
<div class="card" style="margin-bottom:20px; padding:20px;">
    <h2 style="text-align:center;">ğŸ“Š Overall Goals Summary</h2>
    <div style="display:flex; justify-content:space-around; align-items:center; flex-wrap:wrap;">
        
        <div style="text-align:center; margin:10px;">
            <h3>Total Goals</h3>
            <p style="font-size:1.5em;">{{ total_goals }}</p>
        </div>

        <div style="text-align:center; margin:10px;">
            <h3>Total Target</h3>
            <p style="font-size:1.5em; color:#c97610;">
                {{ total_target }}
            </p>
        </div>

        <div style="text-align:center; margin:10px;">
            <h3>Total Current</h3>
            <p style="font-size:1.5em; color:#00BFA6;">
                {{ total_current }}
            </p>
        </div>
        <div style="margin:10px; text-align:center;">
            <h3>ğŸ’° Remaining Surplus</h3>
            {% if remaining_surplus > 0 %}
                <p style="font-size:1.5em; font-weight:bold; color:green;">
                    +{{ remaining_surplus|floatformat:2 }}
                </p>
            {% elif remaining_surplus < 0 %}
                <p style="font-size:1.5em; font-weight:bold; color:red;">
                    {{ remaining_surplus|floatformat:2 }}
                </p>
            {% else %}
                <p style="font-size:1.5em; font-weight:bold; color:gray;">
                    {{ remaining_surplus|floatformat:2 }}
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Overall Progress Bar -->
    <div style="margin-top:20px;">
        <h3 style="text-align:center;">Overall Progress</h3>
        <div style="background:#e0e0e0; border-radius:10px; overflow:hidden; height:25px; width:100%;">
            <div style="height:100%; width:{{ overall_progress }}%;
                        background:{% if overall_progress < 30 %}#ff4d4d
                                   {% elif overall_progress < 70 %}#ffcc00
                                   {% else %}#00cc66{% endif %};
                        display:flex; align-items:center; justify-content:center;
                        font-weight:bold; color:white; transition:width 0.5s ease;">
                {{ overall_progress|floatformat:2 }}%
            </div>
        </div>
    </div>
</div>



    {% comment %} <a href="{% url 'add_goal' %}"><button>Add Goal</button></a>
    <a href="{% url 'add_deposit' %}"><button>Add Deposit</button></a> {% endcomment %}
    <!-- Manage Budgets Card -->
    <div class="card" style="display:flex; align-items:center; justify-content:space-between;">
        <h2>âš™ï¸ Manage Saving Goals</h2>
        <div style="display:flex; gap:10px;">
            <a href="{% url 'add_goal' %}"><button>â• Add New Goal</button></a>

            <form id="delete-selected-form" action="{% url 'delete_selected_goals' %}" method="post" style="margin:0; padding:0;">
                {% csrf_token %}
                <input type="hidden" name="selected_ids" id="selected-ids">
                <button type="submit" class="delete-button" onclick="return confirm('Delete selected saving goals?')">ğŸ—‘ï¸ Delete Selected</button>
            </form>
            <form action="{% url 'delete_all_goals' %}" method="post" style="margin:0; padding:0;">
                {% csrf_token %}
                <button type="submit" class="delete-button" onclick="return confirm('Delete all saving goals?')">ğŸ—‘ï¸ Delete All</button>
            </form>
        </div>
    </div>
    <table>
        <tr>
            <th style="padding:10px;"><input type="checkbox" id="select-all"></th>
            <th>Goal</th>
            <th>Target</th>
            <th>Current</th>
            <th>Progress</th>
            <th>Deadline</th>
            <th>Actions</th>
        </tr>
        {% for goal in goals %}
        <tr>
            <td style="text-align:center; padding:8px;">
                    <input type="checkbox" class="row-checkbox" data-goal-id="{{ goal.id }}">
            </td>
            <td>{{ goal.name }}</td>
            <td>{{ goal.target_amount }}</td>
            <td>{{ goal.current_amount }}</td>
            {% comment %} <td>{{ goal.progress }}%</td>
            <td>{{ goal.deadline|default:"N/A" }}</td> {% endcomment %}
            <td>
                <div class="progress-container">
                    <div class="progress-bar 
                        {% if goal.progress < 30 %}progress-low
                        {% elif goal.progress < 70 %}progress-medium
                        {% else %}progress-high{% endif %}"
                        style="width: {{ goal.progress }}%">
                        {{ goal.progress }}%
                    </div>
                </div>
            </td>
            <td>{{ goal.deadline|default:"N/A" }}</td>
            <td class="action-buttons">
                <a href="{% url 'edit_goal' goal.id %}"><button class="edit-button">Edit</button></a>
                <form method="post" action="{% url 'delete_goal' goal.id %}" style="display:inline;" onsubmit="return confirm('âš ï¸ Are you sure you want to delete {{ goal.name }}?');">
                    {% csrf_token %}
                    <button type="submit" class="delete-button">Delete</button>
                </form>
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="7">No savings goals yet.</td></tr>
        {% endfor %}
    </table>
    <!-- Pagination -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin:20px 0; flex-wrap:nowrap; gap:15px;">

        <!-- Left: Page info -->
        <div style="white-space:nowrap; color:#E0E0E0; font-weight:bold;">
            <h2>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</h2>
        </div>

        <!-- Right: Pagination controls -->
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:nowrap;">

            <!-- Previous -->
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}">
                    <button type="button" style="padding:6px 12px;">Â« Previous</button>
                </a>
            {% else %}
                <button type="button" style="padding:6px 12px;" disabled>Â« Previous</button>
            {% endif %}

            <!-- Sliding window of 5 pages -->
            {% for num in page_range %}
                {% if page_obj.number == num %}
                    <button type="button" class="edit-button" style="padding:6px 12px; font-weight:bold; height:40px;" disabled>{{ num }}</button>
                {% else %}
                    <a href="?page={{ num }}">
                        <button type="button" style="padding:6px 12px;">{{ num }}</button>
                    </a>
                {% endif %}
            {% endfor %}

            <!-- Next -->
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">
                    <button type="button" style="padding:6px 12px;">Next Â»</button>
                </a>
            {% else %}
                <button type="button" style="padding:6px 12px;" disabled>Next Â»</button>
            {% endif %}
        </div>
    </div>
    <div class="card">
        <h2 style="text-align:center;">ğŸ“Š Goal Progress Overview</h2>
        <canvas id="progressChart"></canvas>
    <div class="chart-legend" style="text-align: center;">
        <span class="legend-item">
            <span class="legend-box" style="background-color: #ff4d4d;"></span> Low (<30%)
        </span>
        <span class="legend-item">
            <span class="legend-box" style="background-color: #ffcc00;"></span> Medium (30â€“70%)
        </span>
        <span class="legend-item">
            <span class="legend-box" style="background-color: #00cc66;"></span> High (â‰¥70%)
        </span>
    </div>
    </div>
    

</main>
</div>
<footer>Personal Finance Manager</footer>

<script>
    // Auto-hide popup messages
    setTimeout(() => {
        document.querySelectorAll(".popup-message").forEach(msg => {
            msg.classList.add("fade-out");
            setTimeout(() => msg.remove(), 500);
        });
    }, 3000);
    

    // Delete selected goals
    document.getElementById("delete-selected-form").addEventListener("submit", function (e) {
    const ids = Array.from(document.querySelectorAll(".row-checkbox:checked")).map(cb => cb.dataset.goalId);
    document.getElementById("selected-ids").value = ids.join(",");
    });
    // Select/Deselect all checkboxes
    document.getElementById("select-all").addEventListener("change", function() {
        document.querySelectorAll(".row-checkbox").forEach(cb => cb.checked = this.checked);
    });
    const labels = {{ labels|safe }};
    const progress = {{ progress|safe }};

    const backgroundColors = progress.map(val => {
        if (val < 30) return 'rgba(255, 77, 77, 0.7)';      // red
        if (val < 70) return 'rgba(255, 204, 0, 0.7)';      // yellow
        return 'rgba(0, 204, 102, 0.7)';                    // green
    });

    const borderColors = progress.map(val => {
        if (val < 30) return 'rgba(204, 0, 0, 1)';
        if (val < 70) return 'rgba(255, 153, 0, 1)';
        return 'rgba(0, 153, 77, 1)';
    });

    const ctx = document.getElementById('progressChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Progress (%)',
                    data: progress,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1,
                    borderRadius: 8,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (c) => c.raw + "%" } },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#fff',
                        font: { weight: 'bold' },
                        formatter: (val) => val + '%'
                    }
                },
                scales: {
                    y: { beginAtZero: true, max: 100, ticks: { callback: val => val + "%" } }
                }
            },
            plugins: [ChartDataLabels]
        });
    }
</script>



</body>
</html>
{% comment %} // Populate selected IDs before submitting "Delete Selected" form
    const deleteSelectedForm = document.getElementById("delete-selected-form");
    deleteSelectedForm.addEventListener("submit", function(e) {
        const selectedIds = Array.from(document.querySelectorAll(".row-checkbox:checked"))
                                 .map(cb => cb.getAttribute("data-budget-id"))
                                 .join(",");
        if (!selectedIds) {
            alert("Please select at least one goal to delete.");
            e.preventDefault();
            return;
        }
        document.getElementById("selected-ids").value = selectedIds;
    }); {% endcomment %}